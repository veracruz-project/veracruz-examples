# Terraform script to install veracruz i-poc example  on AWS EC2

This script installs Veracruz i-PoC example using helm charts into two AWS EC2 instances.. 

It assumes that the environment variables AWS\_ACCESS\_KEY\_ID, AWS\_SECRET\_ACCESS\_KEY and AWS\_SESSION\_TOKEN are set correctly so Terraform can access AWS.
Set the following variables to correct values:
region (provider "aws"): AWS region to allocate an EC2 instance on.

Required variables:

* letsencrypt\_email

Optional variables:

* deployment\_name: Prefix to apply to object names.
* AWS\_EC2\_instance\_type: instance type to be used
* AWS\_EC2\_agent\_instance\_type: instance type to be used for Nitro worker instances
* AWS\_VPC\_subnet\_id: subnet_id use the default of the VPC if this is not defined

## Run the following commands if setting the variables on the command line

```
terraform init
# optional: terraform plan -var "letsencrypt_email=<valid email>"
terraform apply -var "letsencrypt_email=<valid email>"
```

## Checking status of installation

Please observe that the full installation of k3s, helm charts in the EC2 instance can take up to 15min (expected around 10min) with various parts of the system being available at different times. If it is desired to follow the installation the command below will print the current log and follow it 

```bash
ssh -i ssh/<deployment-name>-prod-k3s.pem ubuntu@<EC2 instance allocated> "tail -f /var/log/cloud-init-output.log"
```

## Outputs

Terraform will output the names of EC2 instances allocated and password/ID generated by Terraform.

# Troubleshooting

## AWS authentication

Use the AWS credentials provided in the "Get credentials for ProjAdmins" page.
Terraform expects the following environment variables: AWS\_ACCESS\_KEY\_ID, AWS\_SECRET\_ACCESS\_KEY and AWS\_SESSION\_TOKEN.

## Networking

If an error is reported about "default subnet not found", a subnet was not defined as default for the VPC. A subnet can be set using the AWS\_VPC\_subnet\_id variable.

## Debugging information

Log in to the EC2 machine  using the ssh command

```bash
ssh -i ssh/<deployment-name>-prod-k3s.pem ubuntu@<EC2 instance allocated>
```

Please take a look at the log at /var/log/cloud-init-output.log and /var/log/cloud-init.log at the EC2 machine to determine where the program failed
The script that is executed is called part-002
